
<!DOCTYPE html>

<html lang="en">
<%- include('../partials/theader'); %>
<meta charset="UTF-8" name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
<meta name="description" content="Sale and Purchase Inventory For All Kind of Trade, Develop Utility Software "/>
<meta name="keywords" content="MEDI TRADE SOLUTIONS, MEDI SOFT, MEDICAL Billing Software, Abishek Gupta,  ERP, Pharmaceutical WholeSale Inventory">
<meta name="Author" content="Abhishek Gupta, me.abhi.deo.18@gmail.com">
<title><%= spinfo.title  %></title>
<script  type="text/javascript" src="public/assets/js/minajax.js"></script>
<script  type="text/javascript" src="public/assets/js/typeahead.min.js"></script>
<script  type="text/javascript" src="public/assets/js/itemappend.js"></script>
<script  type="text/javascript" src="public/assets/js/mediinputvalidate.js"></script>
<script  type="text/javascript" src="public/assets/js/saveprint.js"></script>
<script  type="text/javascript" src="public/assets/js/jsPDF.js"></script>
<link rel="stylesheet" href="public/assets/css/mystyles.css"> 
<link rel="stylesheet" href="public/assets/css/bootstrap.css"> 

<body>
  <label hidden="hidden" id='sp'><%= spinfo.cs %> </label>  
 
      <div class="container">
        <label id="billdatestx" class="rmslabel1"> Bill Date:</label>
        <input type="date" id="billdate" name="billdate" class="textinput" 
                placeholder="dd/mm/yy" min="2020-01-01" value="<%= prows.billdate %>" >

        <label id="invdatestx" class="rmslabel1">Inv Date</label>
    
        <input type="date" id="invoicedate" name="invoicedate" class="textinput" 
                placeholder="dd/mm/yy" min="2020-01-01" value="<%= prows.invdate %>">

        <label id="searchstxt" ><%= spinfo.cs %> Name: </label>
        <input type="text" name="supsearch" id="supsearch" value="<%= prows.name %>"
               class="form-control typeahead tt-query" placeholder='Party Name' autofocus="autofocus" autocomplete="off"
               style="text-transform:uppercase; width:400px;" >
        <div>

        <table  id="plist" class="partylist"></table>
        </div>
      
      <div id="divtop2" class="btcontainer">
      <div class="rmsdiv">
        <label id="blink" class="blink_me"></label>
        <label id='add1' class="rmslbblue" ></label>
        <label id='add2' class="rmslbblue"></label>
        <label id='mobile' class="rmslbblue"> </label>
        <label id='regn' class="rmslbblue"> </label>
        <label id='gstn' class="rmslbblue"> </label>
        <label id='bal' class="rmslbblue"> </label>
  	  </div>
    </div>
    <div id="alerts"></div> 
    
    <div id="divtop3" class="btcontainer">
    <div id="bt3part1">
      <label id="cscrstx" class="rmslabel1">Cash/Credit</label>
      <select id="cscr" name="cscr" >
        <option value="CASH">CASH</option>
        <option value="CREDIT">CREDIT</option>
        <option value="CHALLAN">CHALLAN</option>
      </select>
      
      <label id="estistxt" class="rmslabel1">Esti</label>
      <input type="text" id="esti" name="esti" class="estivalidate" placeholder="E" maxlength="1">
    
      <label id="status"></label>
      <label id="billnostx" class="rmslabel1">Inv.No:</label>
      <input type="text" name="billno" id='billno' class="rmsinput100" value="<%= prows.billno %>" >
      <label id="ddiscstx" class="rmslabel1">D.Disc:</label>
      <input type="text" name="ddisc" id='ddisc' class="rmsgriddiscount" maxlength="5" value="0" >
      <br>
      <label id="statusinfo" class="rmslabel1" ></label>
      <label id="statusinfo2" class="rmslabel1"></label>
    </div>
    </div>
    <form class="form-inline">
    <div id="xitembox" class="scroll">
        <table id="itembox" >
            <script type="text/javascript" charset="utf-8">
                tableColumnHeader(); 
                let speditdata = SPEDIT_appendRow('<%= JSON.stringify(prows) %>', '<%= JSON.stringify(itemrows) %>');
                //let speditdata = SPEDIT_appendRow('<%-JSON.stringify(prows) %>', '<%-JSON.stringify(itemrows) %>');
                 let prows=speditdata['prows'];
                 let itemrows=speditdata['itemrows'];
            </script>
            
        </table>
        <table  id="itemlist" class="dptable"></table>

    </div>
    </form>
    
    <div id="divbtm1" style="display: inline-block; width: 80%">
        <label id='gtotstx' class="btmtextsumdp" style=" color:blue;font-size:105%;">Bill Total: </label>
        <label id='gtot' class="btmtextsumdp" style="width:auto; font-size:125%;text-align:center;background-color:yellow;"></label>
        <label style="width:7%;"></label>
        <label id='subtotstx' class="btmstaticsumdp">SubTotal: </label>
        <label id='tsubtot' class="btmtextsumdp" ></label>
        <label style="width:3%; text-align:center;"></label>
        <label id='addtaxstx' class="btmstaticsumdp">GST.Amt: </label>
        <label id='ttaxamt' class="btmtextsumdp" ></label>
        <label style="width:3%; text-align:center;"></label>
        <label id='disamtstx' class="btmstaticsumdp">Disc.Amt: </label>
        <label id='tdisamt' class="btmtextsumdp" ></label>
        <label id='raw_gtot' hidden >0.0</label>
    </div>

  
  
    <div id="divbtm2" style="display: inline-block; width: 80%">
        <input type="text" id="cmnt" name="cmnt" class="billcomment" placeholder="bill comment">
        <label id='prlo' class="textdpprlo" style="width:7%; text-align:center;">0.0</label>
        
        <br><button class="btn btn-primary" id="printconfirm" class="mbtmbt" style="display:none;"> PRINT </button>
        <br><button class="btn btn-primary" id="deleteconfirm" class="mbtmbt" style="display:none;"> DELETE </button>
        &nbsp;<button class="btn btn-primary" id="printcancel" class="mbtmbt" style="display:none;"> CANCEL </button>

        <label id='cgststx' class="btmstaticsumdp">CGST:</label>
        <label id='cgst' class="btmtextsumdp" ></label>
        <label style="width:2%; text-align:center;"></label>
        <label id='sgststx' class="btmstaticsumdp">SGST:</label>
        <label id='sgst' class="btmtextsumdp" ></label>
        <label style="width:2%;"></label>
        <label id='tamtstx' class="btmstaticsumdp">Amt.Total: </label>
        <label id='tamt' class="btmtextsumdp" ></label>
  </div>
  
    <div id="divbtm3" style="display: inline-block; width: 80%">
        <button type="button" id="update" class="btn btn-outline-primary" onclick="onUpdate()"> &nbsp; Update &nbsp;</button>
        <button type="button" id="delete" class="btn btn-outline-primary" onclick="onDelete()">&nbsp; Delete &nbsp;</button>
        
        <form id="backtohome" method="POST" action="/medinav">
            <tr><button type="submit" class="btn btn-outline-primary" id="close" name="name" value="medihome" > &nbsp; CLOSE &nbsp; </button></tr> 
        </form>

        <label style="width:2%; text-align:center;"></label>
        <label id='roundoffstx' class="btmstaticsumdp" >Round-Off: </label>
        <label id='roundoff' class="btmtextsumdp" ></label>
        <label style="width:2%; text-align:center;"></label>
        <input type="text" id="acname1" name="acname1" class="acname"  placeholder="Account Name">
        <input type="text" id="acval1" name="acval1" class="rmsgridfloatval" placeholder="Value">
    </div>
  
    <div id="bt4part1" class="rmsdiv">
        <button type="button" id="exportpdf" class="btn btn-outline-primary"  onclick="onPDF()">PDF Export</button>
        <button type="button" id="exportxls" class="btn btn-outline-primary"  onclick="onXLS()">Excel Export</button>
        <label style="width:30%; padding-right: 20px;"></label>
        <label style="width:40%; text-align:left;">Sample2_2 widg: </label>
        <label style="padding-right: 30px;"></label>
    </div>

</div>
<div>
    <footer class="mydocfooter">
  
     
      <div class="footerblock-1">
        <h7>About Us</h7>
        <li> <a href="#"  > Medi-Trade  </a></li>
        <li> <a href="#" > Tech-Med </a></li>
        <li><a href="#"> GST & SALES & PURCHASE </a></li>
      </div>

      <div class="footerblock-2">
        <h7>Informations</h7>
        <li> <a href="https://www.linkedin.com/in/abhishek-gupta-a1a44a203/"  target="_blank"> Linkedin <i class="fa-brands fa-linkedin fa-lg"></i> </a></li>
        <li> <a href="https://github.com/cosmos-dx/"  target="_blank"> GitHub <i class="fa-brands fa-github-alt fa-lg"></i> </a></li>
        <li><a href="https://auth.geeksforgeeks.org/user/abhishekgupta1802/"  target="_blank">GeeksForGeeks<i class="fa-light fa-code-simple fa-lg"></i></a></li>
      </div>

      <div class="footerblock-3">
        <h7>Contact</h7>
        <li> <a href="#"  > HelpLine </a></li>
        <li> <a href="#" > YouTube  </a></li>
        <li><a href="#" > Twitter </a></li>
      </div>


      <p> &copy;MEDI-TRADE - <span> abhishekgupta0118@gmail.com </span></p>
    </footer> 
 </div>
</body>
</html>

<script type="text/javascript" charset="utf-8">
  
    var clicked;
    var kyi = -1;
    var rowlen ;
    var dbcscr = {'CASH':'1','CREDIT':'2', 'CHALLAN':'3'}
    var rvcscr = {'1':'CASH','2':'CREDIT', '3':'CHALLAN'}
    var estidict = {'e':'E','E':'E','m':'M','M':'M','':'M','undefined':'M', ' ':'M'}
    var idcount = -1;
    var csdatalimit = 10; 
    const posdict = POSDICT();
    var partyrows; 
    //var itemrows ;
    var itemdatalimit = 5; 

    var cs =  '<%= spinfo.cs %>'; 
    var sp = cs;
    var cssearch = '<%- spinfo.cssearch %>';
    var spinfo = '<%- JSON.stringify(spinfo) %>' ;
    var itemdata = '<%- JSON.stringify(itemrows) %>' ;
    var pdata = '<%- JSON.stringify(prows) %>' ;
    var acdata = '<%-JSON.stringify(acrows) %>' ;
    var recdic={'pan':pdata,'grid':itemdata,'ac':acdata,'static':{},'edit':false, 'other':{}}
    var cshost = document.URL.substring(0, document.URL.lastIndexOf("/")+1)+'partysearchenter' ;
    var itemhost = document.URL.substring(0, document.URL.lastIndexOf("/")+1)+'itemsearchenter' ; 
    var info = ['axy','first info','b','second, info'];
    var fyear =  parseInt('<%- spinfo.fyear %>');
    var owner = JSON.parse('<%- JSON.stringify(spinfo.owner) %>'); 
    var userinfo = JSON.parse('<%- JSON.stringify(spinfo.userinfo) %>'); 
    var bankinfo = JSON.parse('<%- JSON.stringify(spinfo.bankinfo) %>'); 
    //var recdic = {"pan":{},"grid":{},"ac":{},"edited":false};
    var recdic_template = JSON.parse('<%- JSON.stringify(spinfo.recdic) %>');
    var rscr = {"userinfo":userinfo, "bankinfo":bankinfo};

function PageRedirect(cs){
    if(cs=="customer"){window.location.href = window.location.origin+"/medinav?id=ssales";}
    else{window.location.href = window.location.origin+"/medinav?id=spurchase";}
}

$(document).ready(function(){

   idcount += itemdata.length;
  var cs = document.getElementById("sp").innerHTML.toLowerCase();
  searchTypeAhead('#supsearch',cs,'GET', {wildcard: '%QUERY',url:cshost+"?key=%QUERY"+"&info=%"+info+"&limit="+csdatalimit }, csdatalimit)

  document.getElementById("cscr").value = rvcscr[prows["cscr"]];
  document.getElementById("add1").innerHTML=prows["add1"];
  document.getElementById("add2").innerHTML=prows["add2"];
  document.getElementById("regn").innerHTML=prows["regn"];
  document.getElementById("gstn").innerHTML=prows["gstn"];
  document.getElementById("add1").innerHTML=prows["add1"];
  document.getElementById("mobile").innerHTML=prows["mobile"];
  document.getElementById("bal").innerHTML="0.00";
  document.getElementById("blink").innerHTML="*** EDIT ON ***";

  var billgamt = parseFloat(prows["gamt"]).toFixed(2);
  var roundgamt = parseFloat(prows["gamt"]).toFixed(0);
  var roundoffval = billgamt - roundgamt;

  document.getElementById("gtot").innerHTML="Rs " + roundgamt.toString() + "/-";
  document.getElementById("raw_gtot").innerHTML=roundgamt;
  document.getElementById("roundoff").innerHTML=roundoffval.toFixed(2).toString();

  document.getElementById("tsubtot").innerHTML=prows["amt"];
  document.getElementById("tamt").innerHTML=prows["tamt"];
  document.getElementById("ttaxamt").innerHTML=prows["ttaxamt"];
  document.getElementById("tdisamt").innerHTML=prows["tdisamt"];
  document.getElementById("cgst").innerHTML=prows["cgst"];
  document.getElementById("sgst").innerHTML=prows["sgst"];
  // //  onItemSearch('#'+idcount+'_itemsearch');
  
  $("#printcancel").click(function(){
      PageRedirect(cs.trim());
    });
  
  $("#printconfirm").click(function(){
      try{
        recdic['pan']['email']='abcd@efgh.com';
        recdic['pan']['tamt']=document.getElementById("tamt").innerHTML ;
        recdic['pan']['tdisamt']=document.getElementById("tdisamt").innerHTML ;
        recdic['pan']['ttaxamt']=document.getElementById("ttaxamt").innerHTML ;
        recdic['pan']['tsubtot']=document.getElementById("tsubtot").innerHTML ;
        recdic['pan']['roundoff']=document.getElementById("roundoff").innerHTML ;
        recdic['pan']['gtot']=recdic['pan']["gamt"] ;
        recdic['pan']['rgtot']=document.getElementById("gtot").innerHTML ;
        recdic['grid']=itemrows;
        CreatePDF(rscr, recdic, ornt="landscape")
        PageRedirect(cs.trim());
      }
      catch(err){CreateAlertDiv("Cannot Generate PDF ["+err.message+" ]"); }
      document.getElementById("statusinfo").innerHTML="PDF Exported !!";
    });

  $("#deleteconfirm").click(function(){

    let savebool = true;
    if(typeof(recdic['pan'])==="string"){
        recdic["pan"] = JSON.parse(recdic["pan"]);
    }
    
    RecdicPanFill();
    //console.log(recdic);
    /*matching keys that is used to insert into database*/

    recdic['pan']["fyear"]=fyear;
    
    if(typeof(recdic['grid'])==="string"){
        recdic["grid"] = itemrows; 
    }

    DbSaveBill(recdic, cs.trim(), "delete", "POST", "/sendbilltodb");
    hidePrintConfirm()
    PageRedirect(cs.trim());
    
    });

  });


function onUpdate(evt){
    let savebool = true;
    if(typeof(recdic['pan'])==="string"){
        recdic["pan"] = JSON.parse(recdic["pan"]);
    }
    
    RecdicPanFill();
    //console.log(recdic);
    /*matching keys that is used to insert into database*/
    //recdic['pan']["csid"]=recdic['pan']["csid"];
    recdic['pan']["fyear"]=fyear;
    
    if(typeof(recdic['grid'])==="string"){
        recdic["grid"] = itemrows; 
    }
    savebool = validateDBEntry(savebool);
    
    if (savebool){
        if(typeof recdic['grid'][0]["qty"] == 'undefined'){
            document.getElementById("statusinfo").innerHTML=" No Items Selected !";
            document.getElementById("statusinfo2").innerHTML=" Cannot Save !";
            return false;
        }
        //console.log(recdic['ac']);
        //console.log(recdic['grid']);
        DbSaveBill(recdic, cs.trim(), "update", "POST", "/sendbilltodb");
        showPrintConfirm(); // << This Should not be called here; should call after successfully insert data into database

        }
}

function showDeleteConfirm(){
  $('#save').css('display', 'none');
  $('#update').css('display', 'none');
  $('#delete').css('display', 'none');
  $('#reset').css('display', 'none');
  $('#close').css('display', 'none');
  $('#exportpdf').css('display', 'none');
  $('#exportxls').css('display', 'none');
  $('#printconfirm').css('display', 'none');
  $('#deleteconfirm').css('display', 'inline-flex');
  $('#printcancel').css('display', 'inline-flex');
  $('#deleteconfirm').css('text-align', 'center');
  $('#printcancel').css('text-align', 'center');
  $('#deleteconfirm').focus();
  }

function onDelete(evt){showDeleteConfirm()}

function onClose(){
    document.getElementById("status").innerHTML=sp;}
    
function onPDF(evt){
    if(typeof(recdic['pan'])==="string"){
        recdic["pan"] = JSON.parse(recdic["pan"]);
    }
    if(typeof(recdic['grid'])==="string"){
        recdic["grid"] = itemrows; 
    }
    if(RecdicPanFill()){
        showPrintConfirm()
    }
    //document.getElementById("status").innerHTML="PDF Export Button Pressed";
    }
function onXLS(evt){
    document.getElementById("status").innerHTML="Excell Export Button Pressed";}

</script>




